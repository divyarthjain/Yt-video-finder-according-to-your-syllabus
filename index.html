<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI YouTube Video Finder - Advanced Syllabus Matcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .video-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .video-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .video-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .video-card:hover::before {
            left: 100%;
        }

        .topic-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        .floating-shapes {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .shape {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 50%;
            animation: float 20s infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-100px) rotate(180deg);
            }
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        /* Fix for missing line-clamp */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Fix for aspect ratio */
        .aspect-video {
            aspect-ratio: 16 / 9;
        }

        .aspect-video iframe {
            width: 100%;
            height: 100%;
        }

        /* Error message styling */
        .error-message {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 1rem 0;
        }

        /* API Warning */
        .api-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Floating Shapes Background -->
    <div class="floating-shapes">
        <div class="shape" style="width: 80px; height: 80px; left: 10%; top: 20%; animation-delay: 0s;"></div>
        <div class="shape" style="width: 120px; height: 120px; left: 70%; top: 50%; animation-delay: 2s;"></div>
        <div class="shape" style="width: 60px; height: 60px; left: 85%; top: 10%; animation-delay: 4s;"></div>
        <div class="shape" style="width: 100px; height: 100px; left: 25%; top: 80%; animation-delay: 6s;"></div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-5xl font-bold text-white mb-3">
                <i class="fas fa-graduation-cap mr-3"></i>AI YouTube Video Finder
            </h1>
            <p class="text-white/90 text-lg">Transform your syllabus into a personalized video learning experience</p>
        </div>

        <!-- API Key Setup (Enhanced) -->
        <div id="apiKeySection" class="glass-morphism rounded-2xl p-8 mb-8 shadow-2xl">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-key text-white text-xl"></i>
                </div>
                <h2 class="text-2xl font-semibold text-gray-800">Quick Setup</h2>
            </div>

            <!-- CORS Warning -->
            <div class="api-warning mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-exclamation-triangle text-2xl mt-1"></i>
                    <div>
                        <h4 class="font-semibold mb-2">Important: CORS Limitations</h4>
                        <p class="text-sm">Due to browser security restrictions, this app cannot directly access YouTube API. For full functionality, you'll need to:</p>
                        <ul class="text-sm mt-2 space-y-1 list-disc list-inside">
                            <li>Set up a backend server to proxy API requests</li>
                            <li>Or use browser extensions to bypass CORS</li>
                            <li>Current version includes demo functionality</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <p class="text-gray-700 mb-4">To unlock this powerful tool, you need a YouTube Data API key:</p>
                    <ol class="space-y-2 text-gray-600">
                        <li class="flex items-start">
                            <span class="bg-purple-100 text-purple-700 rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2 mt-0.5">1</span>
                            <span>Visit <a href="https://console.cloud.google.com/" target="_blank" class="text-purple-600 hover:underline font-medium">Google Cloud Console</a></span>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-purple-100 text-purple-700 rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2 mt-0.5">2</span>
                            <span>Create a new project</span>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-purple-100 text-purple-700 rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2 mt-0.5">3</span>
                            <span>Enable YouTube Data API v3</span>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-purple-100 text-purple-700 rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2 mt-0.5">4</span>
                            <span>Generate your API key</span>
                        </li>
                    </ol>
                </div>
                <div class="flex flex-col justify-center">
                    <div class="bg-gray-50 rounded-xl p-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your API Key</label>
                        <div class="flex gap-2">
                            <input type="password" id="apiKeyInput" placeholder="Paste your API key here"
                                   class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 transition">
                            <button onclick="saveApiKey()"
                                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition shadow-lg">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                        </div>
                        <button onclick="useDemoMode()"
                                class="w-full mt-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-play mr-2"></i>Try Demo Mode
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Interface (Enhanced) -->
        <div id="mainInterface" class="hidden">
            <!-- Stats Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="stats-card rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm">Total Topics</p>
                            <p class="text-2xl font-bold" id="totalTopics">0</p>
                        </div>
                        <i class="fas fa-list text-white/50 text-2xl"></i>
                    </div>
                </div>
                <div class="stats-card rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm">Videos Found</p>
                            <p class="text-2xl font-bold" id="videosFound">0</p>
                        </div>
                        <i class="fas fa-video text-white/50 text-2xl"></i>
                    </div>
                </div>
                <div class="stats-card rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm">Saved Videos</p>
                            <p class="text-2xl font-bold" id="savedVideos">0</p>
                        </div>
                        <i class="fas fa-bookmark text-white/50 text-2xl"></i>
                    </div>
                </div>
                <div class="stats-card rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm">Study Time</p>
                            <p class="text-2xl font-bold" id="studyTime">0h</p>
                        </div>
                        <i class="fas fa-clock text-white/50 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="glass-morphism rounded-2xl shadow-2xl overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button onclick="switchTab('search')" id="searchTab" class="tab-active px-6 py-4 font-medium transition flex items-center gap-2">
                        <i class="fas fa-search"></i> Search Videos
                    </button>
                    <button onclick="switchTab('saved')" id="savedTab" class="px-6 py-4 font-medium text-gray-600 hover:text-gray-800 transition flex items-center gap-2">
                        <i class="fas fa-bookmark"></i> Saved Videos
                    </button>
                    <button onclick="switchTab('history')" id="historyTab" class="px-6 py-4 font-medium text-gray-600 hover:text-gray-800 transition flex items-center gap-2">
                        <i class="fas fa-history"></i> Search History
                    </button>
                </div>

                <!-- Search Tab Content -->
                <div id="searchContent" class="p-8">
                    <!-- Syllabus Input Section -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-file-alt text-purple-600"></i> Enter Your Syllabus
                            </h2>
                            <button onclick="loadSampleSyllabus()" class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                                <i class="fas fa-magic mr-1"></i> Load Sample
                            </button>
                        </div>
                        <div class="relative">
                            <textarea id="syllabusInput" rows="6" placeholder="Enter your topics here... (one per line)"
                                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 transition resize-none custom-scrollbar"></textarea>
                            <div class="absolute bottom-3 right-3 text-sm text-gray-400">
                                <span id="topicCount">0</span> topics
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Filters -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-purple-600"></i> Advanced Filters
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Videos per Topic</label>
                                <select id="videosPerTopic" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500">
                                    <option value="3">3 videos</option>
                                    <option value="5" selected>5 videos</option>
                                    <option value="10">10 videos</option>
                                    <option value="15">15 videos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                                <select id="durationFilter" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500">
                                    <option value="">Any duration</option>
                                    <option value="short">Short (< 4 min)</option>
                                    <option value="medium">Medium (4-20 min)</option>
                                    <option value="long">Long (> 20 min)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Date</label>
                                <select id="uploadDate" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500">
                                    <option value="">Any time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This week</option>
                                    <option value="month">This month</option>
                                    <option value="year">This year</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                                <select id="sortBy" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500">
                                    <option value="relevance">Relevance</option>
                                    <option value="date">Upload date</option>
                                    <option value="viewCount">View count</option>
                                    <option value="rating">Rating</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="hdOnly" class="mr-2 w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="text-sm text-gray-700">HD videos only</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="ccOnly" class="mr-2 w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="text-sm text-gray-700">Closed captions</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="educationalOnly" checked class="mr-2 w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="text-sm text-gray-700">Educational channels only</span>
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button onclick="findVideos()" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl hover:from-purple-700 hover:to-purple-800 transition shadow-lg font-medium flex items-center gap-2">
                            <i class="fas fa-search"></i> Find Videos
                        </button>
                        <button onclick="exportResults()" class="px-8 py-3 bg-white border-2 border-purple-600 text-purple-600 rounded-xl hover:bg-purple-50 transition font-medium flex items-center gap-2">
                            <i class="fas fa-download"></i> Export Results
                        </button>
                        <button onclick="clearAll()" class="px-8 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-50 transition font-medium flex items-center gap-2">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Saved Videos Tab -->
                <div id="savedContent" class="p-8 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Saved Videos</h3>
                    <div id="savedVideosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-gray-500 col-span-full text-center py-8">No saved videos yet. Start searching and save your favorites!</p>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="historyContent" class="p-8 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Search History</h3>
                    <div id="searchHistoryList" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">No search history yet.</p>
                    </div>
                </div>
            </div>

            <!-- Loading State (Enhanced) -->
            <div id="loadingState" class="hidden glass-morphism rounded-2xl p-12 text-center">
                <div class="relative inline-block">
                    <div class="w-20 h-20 border-4 border-purple-200 rounded-full animate-spin border-t-purple-600"></div>
                    <i class="fas fa-youtube text-purple-600 text-2xl absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
                </div>
                <p class="mt-6 text-gray-700 font-medium">Searching for educational videos...</p>
                <div class="mt-4 max-w-xs mx-auto">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Processing topic <span id="currentTopicNum">1</span> of <span id="totalTopicNum">1</span></p>
                </div>
            </div>

            <!-- Results Section (Enhanced) -->
            <div id="resultsSection" class="hidden mt-8">
                <div class="glass-morphism rounded-2xl p-8 shadow-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-play-circle text-purple-600"></i> Found Videos
                        </h2>
                        <div class="flex items-center gap-4">
                            <button onclick="toggleView()" class="text-gray-600 hover:text-purple-600 transition">
                                <i id="viewToggleIcon" class="fas fa-th-large text-xl"></i>
                            </button>
                            <button onclick="sortResults()" class="text-gray-600 hover:text-purple-600 transition">
                                <i class="fas fa-sort text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div id="videoResults" class="space-y-8"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Preview Modal -->
    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-semibold text-gray-800"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        let API_KEY = localStorage.getItem('youtubeApiKey') || '';
        let savedVideos = JSON.parse(localStorage.getItem('savedVideos') || '[]');
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let currentView = 'grid';
        let allVideos = [];
        let isDemoMode = false;

        // Initialize
        window.onload = function() {
            if (API_KEY) {
                document.getElementById('apiKeySection').classList.add('hidden');
                document.getElementById('mainInterface').classList.remove('hidden');
            }
            updateStats();
            updateSyllabusCount();

            // Add input listener for topic count
            document.getElementById('syllabusInput').addEventListener('input', updateSyllabusCount);
        };

        function updateSyllabusCount() {
            const topics = document.getElementById('syllabusInput').value.split('\n').filter(t => t.trim()).length;
            document.getElementById('topicCount').textContent = topics;
            document.getElementById('totalTopics').textContent = topics;
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                if (validateApiKey(apiKey)) {
                    API_KEY = apiKey;
                    localStorage.setItem('youtubeApiKey', apiKey);
                    document.getElementById('apiKeySection').classList.add('hidden');
                    document.getElementById('mainInterface').classList.remove('hidden');
                    showNotification('API Key saved successfully!', 'success');
                } else {
                    showNotification('Invalid API key format', 'error');
                }
            } else {
                showNotification('Please enter a valid API key', 'error');
            }
        }

        function validateApiKey(apiKey) {
            // Basic validation for Google API key format
            return apiKey.length >= 30 && /^[A-Za-z0-9_-]+$/.test(apiKey);
        }

        function useDemoMode() {
            isDemoMode = true;
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('mainInterface').classList.remove('hidden');
            showNotification('Demo mode activated! Limited functionality available.', 'info');
        }

        function switchTab(tab) {
            // Update tab styles
            document.querySelectorAll('[id$="Tab"]').forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('text-gray-600', 'hover:text-gray-800');
            });
            const activeTab = document.getElementById(tab + 'Tab');
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('text-gray-600', 'hover:text-gray-800');

            // Update content
            document.querySelectorAll('[id$="Content"]').forEach(c => c.classList.add('hidden'));
            document.getElementById(tab + 'Content').classList.remove('hidden');

            if (tab === 'saved') {
                displaySavedVideos();
            } else if (tab === 'history') {
                displaySearchHistory();
            }
        }

        function loadSampleSyllabus() {
            const samples = [
                "Introduction to Machine Learning\nNeural Networks and Deep Learning\nNatural Language Processing\nComputer Vision Basics\nReinforcement Learning",
                "Web Development Fundamentals\nHTML5 and CSS3\nJavaScript ES6+\nReact.js Framework\nNode.js Backend Development",
                "Data Structures and Algorithms\nArrays and Linked Lists\nTrees and Graphs\nDynamic Programming\nSystem Design Basics"
            ];

            const randomSample = samples[Math.floor(Math.random() * samples.length)];
            document.getElementById('syllabusInput').value = randomSample;
            updateSyllabusCount();
            showNotification('Sample syllabus loaded!', 'success');
        }

        async function searchYouTube(query, maxResults) {
            if (isDemoMode) {
                return generateDemoVideos(query, maxResults);
            }

            const params = new URLSearchParams({
                part: 'snippet',
                q: query + (document.getElementById('educationalOnly').checked ? ' tutorial education course' : ''),
                type: 'video',
                maxResults: maxResults,
                key: API_KEY,
                order: document.getElementById('sortBy').value
            });

            const duration = document.getElementById('durationFilter').value;
            if (duration) params.append('videoDuration', duration);

            const uploadDate = document.getElementById('uploadDate').value;
            if (uploadDate) {
                const dateMap = {
                    'today': new Date(Date.now() - 24*60*60*1000).toISOString(),
                    'week': new Date(Date.now() - 7*24*60*60*1000).toISOString(),
                    'month': new Date(Date.now() - 30*24*60*60*1000).toISOString(),
                    'year': new Date(Date.now() - 365*24*60*60*1000).toISOString()
                };
                params.append('publishedAfter', dateMap[uploadDate]);
            }

            if (document.getElementById('hdOnly').checked) {
                params.append('videoDefinition', 'high');
            }

            if (document.getElementById('ccOnly').checked) {
                params.append('videoCaption', 'closedCaption');
            }

            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?${params}`);

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                return data.items || [];
            } catch (error) {
                console.error('Error searching YouTube:', error);

                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    showNotification('CORS error: Please use a backend server or try demo mode', 'error');
                } else if (error.message.includes('403')) {
                    showNotification('API quota exceeded or invalid key', 'error');
                } else {
                    showNotification('Error searching videos: ' + error.message, 'error');
                }

                return [];
            }
        }

        function generateDemoVideos(query, maxResults) {
            // Generate demo video data
            const demoVideos = [];
            const channels = ['Khan Academy', 'Crash Course', 'TED-Ed', 'MIT OpenCourseWare', 'Coursera'];

            for (let i = 0; i < Math.min(maxResults, 5); i++) {
                demoVideos.push({
                    id: { videoId: `demo_${query.replace(/\s+/g, '_')}_${i}` },
                    snippet: {
                        title: `${query} - Tutorial ${i + 1} (Demo)`,
                        channelTitle: channels[i % channels.length],
                        description: `Demo description for ${query} tutorial`,
                        thumbnails: {
                            medium: {
                                url: `https://via.placeholder.com/320x180/667eea/white?text=${encodeURIComponent(query)}`
                            }
                        }
                    }
                });
            }

            return demoVideos;
        }

        async function findVideos() {
            const syllabusText = document.getElementById('syllabusInput').value.trim();
            if (!syllabusText) {
                showNotification('Please enter your syllabus topics', 'error');
                return;
            }

            const topics = syllabusText.split('\n').filter(topic => topic.trim());
            const videosPerTopic = parseInt(document.getElementById('videosPerTopic').value);

            // Save to history
            const historyEntry = {
                date: new Date().toISOString(),
                topics: topics,
                filters: {
                    videosPerTopic,
                    duration: document.getElementById('durationFilter').value,
                    uploadDate: document.getElementById('uploadDate').value,
                    sortBy: document.getElementById('sortBy').value
                }
            };

            searchHistory.unshift(historyEntry);
            if (searchHistory.length > 10) searchHistory.pop();
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));

            // Show loading state
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('totalTopicNum').textContent = topics.length;

            const resultsContainer = document.getElementById('videoResults');
            resultsContainer.innerHTML = '';
            allVideos = [];

            for (let i = 0; i < topics.length; i++) {
                document.getElementById('currentTopicNum').textContent = i + 1;
                document.getElementById('progressFill').style.width = `${((i + 1) / topics.length) * 100}%`;

                const videos = await searchYouTube(topics[i], videosPerTopic);

                if (videos.length > 0) {
                    videos.forEach(v => v.topic = topics[i]);
                    allVideos = allVideos.concat(videos);
                    const topicSection = createTopicSection(topics[i], videos);
                    resultsContainer.appendChild(topicSection);
                }

                // Add delay to prevent rate limiting
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            // Update stats
            document.getElementById('videosFound').textContent = allVideos.length;
            updateStats();

            // Hide loading state and show results
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            if (allVideos.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No videos found. Try adjusting your filters or search terms.</p>';
            }

            showNotification(`Found ${allVideos.length} videos across ${topics.length} topics!`, 'success');
        }

        function createTopicSection(topic, videos) {
            const section = document.createElement('div');
            section.className = 'mb-8';

            const topicHeader = document.createElement('div');
            topicHeader.className = 'flex items-center justify-between mb-4';
            topicHeader.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <span class="topic-tag">${topic}</span>
                </h3>
                <span class="text-sm text-gray-500">${videos.length} videos found</span>
            `;
            section.appendChild(topicHeader);

            const videosGrid = document.createElement('div');
            videosGrid.className = currentView === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' : 'space-y-4';

            videos.forEach(video => {
                const videoCard = createVideoCard(video);
                videosGrid.appendChild(videoCard);
            });

            section.appendChild(videosGrid);
            return section;
        }

        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer border border-gray-100';

            const videoId = video.id.videoId;
            const videoUrl = isDemoMode ? '#' : `https://www.youtube.com/watch?v=${videoId}`;
            const isSaved = savedVideos.some(v => v.id.videoId === videoId);

            card.innerHTML = `
                <div class="relative group">
                    <img src="${video.snippet.thumbnails.medium.url}" alt="${video.snippet.title}" class="w-full h-48 object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <button onclick="event.stopPropagation(); previewVideo('${videoId}', '${video.snippet.title.replace(/'/g, "\\'")}')"
                                class="bg-white text-purple-600 px-4 py-2 rounded-full font-medium hover:bg-purple-50 transition">
                            <i class="fas fa-play mr-2"></i>Preview
                        </button>
                    </div>
                    <div class="absolute top-2 right-2">
                        <button onclick="event.stopPropagation(); toggleSaveVideo('${videoId}')"
                                class="bg-white/90 backdrop-blur-sm p-2 rounded-full hover:bg-white transition">
                            <i class="${isSaved ? 'fas' : 'far'} fa-bookmark text-purple-600" id="bookmark-${videoId}"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <h4 class="font-medium text-gray-800 line-clamp-2 mb-2">${video.snippet.title}</h4>
                    <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
                        <span class="flex items-center gap-1">
                            <i class="fas fa-user-circle"></i> ${video.snippet.channelTitle}
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <a href="${videoUrl}" target="_blank"
                           class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg text-center hover:bg-purple-700 transition text-sm font-medium ${isDemoMode ? 'pointer-events-none opacity-50' : ''}">
                            <i class="fas fa-external-link-alt mr-1"></i> ${isDemoMode ? 'Demo' : 'Watch'}
                        </a>
                        <button onclick="event.stopPropagation(); shareVideo('${videoUrl}')"
                                class="px-4 py-2 border border-purple-600 text-purple-600 rounded-lg hover:bg-purple-50 transition">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        function toggleSaveVideo(videoId) {
            const video = allVideos.find(v => v.id.videoId === videoId);
            if (!video) return;

            const index = savedVideos.findIndex(v => v.id.videoId === videoId);

            if (index === -1) {
                savedVideos.push(video);
                showNotification('Video saved!', 'success');
            } else {
                savedVideos.splice(index, 1);
                showNotification('Video removed from saved', 'info');
            }

            localStorage.setItem('savedVideos', JSON.stringify(savedVideos));
            updateStats();

            // Update bookmark icon
            const icon = document.getElementById(`bookmark-${videoId}`);
            if (icon) {
                icon.className = index === -1 ? 'fas fa-bookmark text-purple-600' : 'far fa-bookmark text-purple-600';
            }
        }

        function displaySavedVideos() {
            const container = document.getElementById('savedVideosList');

            if (savedVideos.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">No saved videos yet. Start searching and save your favorites!</p>';
                return;
            }

            container.innerHTML = '';
            savedVideos.forEach(video => {
                const card = createVideoCard(video);
                container.appendChild(card);
            });
        }

        function displaySearchHistory() {
            const container = document.getElementById('searchHistoryList');

            if (searchHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No search history yet.</p>';
                return;
            }

            container.innerHTML = '';
            searchHistory.forEach((entry, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-white rounded-lg p-4 border border-gray-200 hover:border-purple-300 transition';

                const date = new Date(entry.date);
                historyItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</p>
                            <p class="font-medium text-gray-800">${entry.topics.length} topics searched</p>
                            <p class="text-sm text-gray-600 mt-1">${entry.topics.slice(0, 3).join(', ')}${entry.topics.length > 3 ? '...' : ''}</p>
                        </div>
                        <button onclick="loadFromHistory(${index})" class="text-purple-600 hover:text-purple-700 font-medium">
                            <i class="fas fa-redo mr-1"></i> Load
                        </button>
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }

        function loadFromHistory(index) {
            const entry = searchHistory[index];
            document.getElementById('syllabusInput').value = entry.topics.join('\n');
            document.getElementById('videosPerTopic').value = entry.filters.videosPerTopic;
            document.getElementById('durationFilter').value = entry.filters.duration;
            document.getElementById('uploadDate').value = entry.filters.uploadDate;
            document.getElementById('sortBy').value = entry.filters.sortBy;

            updateSyllabusCount();
            switchTab('search');
            showNotification('Search loaded from history', 'success');
        }

        function previewVideo(videoId, title) {
            document.getElementById('modalTitle').textContent = title;

            if (isDemoMode) {
                document.getElementById('modalContent').innerHTML = `
                    <div class="bg-gray-100 aspect-video rounded-lg flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-play-circle text-6xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">Demo Mode - Video preview not available</p>
                            <p class="text-sm text-gray-500 mt-2">Use a real API key to watch videos</p>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('modalContent').innerHTML = `
                    <div class="aspect-video">
                        <iframe src="https://www.youtube.com/embed/${videoId}"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen
                                class="w-full h-full rounded-lg">
                        </iframe>
                    </div>
                `;
            }

            document.getElementById('videoModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('videoModal').classList.add('hidden');
        }

        function shareVideo(url) {
            if (navigator.share && !isDemoMode) {
                navigator.share({
                    title: 'Check out this educational video',
                    url: url
                });
            } else {
                if (isDemoMode) {
                    showNotification('Demo mode - sharing not available', 'info');
                } else {
                    navigator.clipboard.writeText(url);
                    showNotification('Video link copied to clipboard!', 'success');
                }
            }
        }

        function toggleView() {
            currentView = currentView === 'grid' ? 'list' : 'grid';
            const icon = document.getElementById('viewToggleIcon');
            icon.className = currentView === 'grid' ? 'fas fa-th-large text-xl' : 'fas fa-list text-xl';

            // Re-render results with new view
            if (allVideos.length > 0) {
                const resultsContainer = document.getElementById('videoResults');
                resultsContainer.innerHTML = '';

                const groupedVideos = {};
                allVideos.forEach(video => {
                    if (!groupedVideos[video.topic]) {
                        groupedVideos[video.topic] = [];
                    }
                    groupedVideos[video.topic].push(video);
                });

                Object.entries(groupedVideos).forEach(([topic, videos]) => {
                    const section = createTopicSection(topic, videos);
                    resultsContainer.appendChild(section);
                });
            }
        }

        function sortResults() {
            // Implement sorting functionality
            showNotification('Sort functionality coming soon!', 'info');
        }

        function exportResults() {
            if (allVideos.length === 0) {
                showNotification('No videos to export', 'error');
                return;
            }

            let csvContent = 'Topic,Title,Channel,URL\n';
            allVideos.forEach(video => {
                const url = isDemoMode ? 'Demo URL' : `https://www.youtube.com/watch?v=${video.id.videoId}`;
                csvContent += `"${video.topic}","${video.snippet.title}","${video.snippet.channelTitle}","${url}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'youtube_videos_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();

            showNotification('Results exported successfully!', 'success');
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all inputs and results?')) {
                document.getElementById('syllabusInput').value = '';
                document.getElementById('videoResults').innerHTML = '';
                document.getElementById('resultsSection').classList.add('hidden');
                allVideos = [];
                updateSyllabusCount();
                updateStats();
                showNotification('All cleared!', 'info');
            }
        }

        function updateStats() {
            document.getElementById('savedVideos').textContent = savedVideos.length;

            // Calculate approximate study time (assuming average video length of 10 minutes)
            const totalMinutes = savedVideos.length * 10;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            document.getElementById('studyTime').textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                ${message}
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Close modal on background click
        document.getElementById('videoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
